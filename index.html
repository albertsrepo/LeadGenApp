<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canadian Finance Prospect Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Inter Font and Tailwind theme -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e40af', // Darker Blue for a professional look
                        'secondary-green': '#059669', // Green for accents/success
                        'gray-bg': '#f3f4f6',
                        'accent-orange': '#f97316',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-bg min-h-screen p-4 sm:p-6 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-primary-blue sm:text-4xl">
                Canadian Finance Lead Manager
            </h1>
            <p class="mt-2 text-lg text-gray-600">
                Securely capture and manage prospects interested in Life Insurance, RRSP, TFSA, and other plans.
            </p>
            <div id="user-info" class="mt-4 text-sm bg-blue-100 text-primary-blue p-2 rounded-lg shadow-sm">
                Loading User ID...
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            
            <!-- Lead Capture Form Card -->
            <div class="bg-white p-6 rounded-xl shadow-2xl h-fit">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">Capture New Prospect</h2>
                <form id="lead-form">
                    
                    <div class="space-y-4 mb-6">
                        <!-- Name Field -->
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue p-3 border">
                        </div>
                        
                        <!-- Contact Fields -->
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="email" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue p-3 border">
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">Phone (Optional)</label>
                            <input type="tel" id="phone" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue p-3 border">
                        </div>

                        <!-- Province Select -->
                        <div>
                            <label for="province" class="block text-sm font-medium text-gray-700">Province/Territory</label>
                            <select id="province" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue p-3 border bg-white">
                                <option value="">Select Province</option>
                                <option value="ON">Ontario (ON)</option>
                                <option value="QC">Quebec (QC)</option>
                                <option value="BC">British Columbia (BC)</option>
                                <option value="AB">Alberta (AB)</option>
                                <option value="MB">Manitoba (MB)</option>
                                <option value="SK">Saskatchewan (SK)</option>
                                <option value="NS">Nova Scotia (NS)</option>
                                <option value="NB">New Brunswick (NB)</option>
                                <option value="NL">Newfoundland and Labrador (NL)</option>
                                <option value="PE">Prince Edward Island (PE)</option>
                                <option value="NT">Northwest Territories (NT)</option>
                                <option value="NU">Nunavut (NU)</option>
                                <option value="YT">Yukon (YT)</option>
                            </select>
                        </div>
                        
                        <!-- Source Select (NEW FIELD) -->
                        <div>
                            <label for="source" class="block text-sm font-medium text-gray-700">Lead Source</label>
                            <select id="source" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue p-3 border bg-white">
                                <option value="">Select Source Forum/Channel</option>
                                <option value="Reddit - CanadaFinance">Reddit - CanadaFinance</option>
                                <option value="LinkedIn">LinkedIn</option>
                                <option value="Facebook Group">Facebook Group</option>
                                <option value="Referral">Referral</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                    </div>

                    <!-- Interest Checkboxes -->
                    <div id="interest-group" class="mb-6 border border-gray-200 p-4 rounded-lg bg-gray-50">
                        <p class="text-md font-semibold text-gray-800 mb-3">Financial Products Interest:</p>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="interest" value="Life Insurance" class="rounded text-primary-blue focus:ring-primary-blue">
                                <span>Life Insurance</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="interest" value="RRSP" class="rounded text-primary-blue focus:ring-primary-blue">
                                <span>RRSP (Retirement)</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="interest" value="TFSA" class="rounded text-primary-blue focus:ring-primary-blue">
                                <span>TFSA (Savings)</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="interest" value="RESP" class="rounded text-primary-blue focus:ring-primary-blue">
                                <span>RESP (Education)</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="interest" value="RDSP" class="rounded text-primary-blue focus:ring-primary-blue">
                                <span>RDSP (Disability)</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" name="interest" value="Investments" class="rounded text-primary-blue focus:ring-primary-blue">
                                <span>General Investments</span>
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" id="submit-btn" class="w-full bg-secondary-green hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md">
                        Add Prospect Lead
                    </button>
                    
                    <!-- Submission Status/Error Message -->
                    <div id="status-message" class="mt-4 text-center font-medium hidden"></div>

                </form>
            </div>

            <!-- Leads List Card -->
            <div class="bg-white p-6 rounded-xl shadow-2xl lg:col-span-1">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">Current Leads</h2>
                
                <div id="leads-list-container" class="overflow-x-auto">
                    <!-- Leads will be rendered here -->
                    <p id="loading-msg" class="text-center text-gray-500 py-8">Loading leads...</p>
                    <table id="leads-table" class="min-w-full divide-y divide-gray-200 hidden">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Province</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Interests</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                            </tr>
                        </thead>
                        <tbody id="leads-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Rows inserted by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Marketing Content Generator Card -->
        <div class="bg-white p-6 rounded-xl shadow-2xl mt-8">
            <h2 class="text-2xl font-bold mb-4 text-primary-blue flex items-center">
                <svg class="w-6 h-6 mr-2 text-accent-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                AI Lead Content Generator
            </h2>
            <p class="mb-4 text-gray-600">Select the financial products you want to market and generate compelling, up-to-date social media copy.</p>
            
            <button id="generate-content-btn" class="w-full bg-accent-orange hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md disabled:opacity-50" disabled>
                Select Product(s) Above to Activate
            </button>

            <div id="content-output-container" class="mt-6 border-t pt-4 hidden">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">Generated Content:</h3>
                <div id="generated-text" class="bg-gray-50 p-4 rounded-lg text-gray-800 whitespace-pre-wrap"></div>
                
                <h4 class="text-sm font-semibold mt-4 text-gray-600">Sources (Google Search Grounding):</h4>
                <ul id="content-sources" class="text-xs text-gray-500 list-disc list-inside mt-1"></ul>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initialAuthToken : null;
        
        // Gemini API Configuration
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const apiKey = ""; // Canvas provides this dynamically
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Set logging for debugging
        setLogLevel('debug');
        
        let userId = '';

        // UI Element References
        const userInfoEl = document.getElementById('user-info');
        const leadForm = document.getElementById('lead-form');
        const submitBtn = document.getElementById('submit-btn');
        const statusMessageEl = document.getElementById('status-message');
        const leadsTableBody = document.getElementById('leads-table-body');
        const leadsTable = document.getElementById('leads-table');
        const loadingMsg = document.getElementById('loading-msg');
        const interestGroup = document.getElementById('interest-group');

        // Content Generator UI Elements
        const generateContentBtn = document.getElementById('generate-content-btn');
        const contentOutputContainer = document.getElementById('content-output-container');
        const generatedTextEl = document.getElementById('generated-text');
        const contentSourcesEl = document.getElementById('content-sources');


        /**
         * Utility function for robust API calls with exponential backoff.
         */
        async function exponentialBackoffFetch(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429 && response.ok) {
                        return response;
                    }
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw new Error(`API request failed with status ${response.status}: ${response.statusText}`);
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // Wait and retry
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        /**
         * 1. Authentication and Initialization
         */
        async function authenticateAndInitialize() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser.uid;
                userInfoEl.textContent = `User ID: ${userId}`;
                
                // Once authenticated, set up the real-time listener
                setupRealtimeLeads();

            } catch (error) {
                console.error("Firebase Auth or Firestore setup failed:", error);
                userInfoEl.textContent = 'ERROR: Authentication failed. Check console for details.';
            }
        }

        /**
         * 2. Form Submission Handler
         */
        leadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';
            statusMessageEl.className = 'mt-4 text-center font-medium text-gray-700';
            statusMessageEl.textContent = 'Processing lead...';
            statusMessageEl.classList.remove('hidden');

            try {
                const name = document.getElementById('name').value.trim();
                const email = document.getElementById('email').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const province = document.getElementById('province').value;
                const source = document.getElementById('source').value; // Get the new source value
                
                const interestCheckboxes = document.querySelectorAll('input[name="interest"]:checked');
                const interests = Array.from(interestCheckboxes).map(cb => cb.value);

                if (!name || !email || !province || !source) {
                    throw new Error("Name, Email, Province, and Source are required.");
                }

                if (interests.length === 0) {
                    console.warn("No specific financial interests selected.");
                }

                // Construct the lead object
                const newLead = {
                    name,
                    email,
                    phone: phone || 'N/A',
                    province,
                    source, // Include the source
                    interests,
                    createdAt: serverTimestamp(),
                    isContacted: false,
                    // Store the user ID of the collector for security
                    collectorId: userId, 
                };

                const collectionPath = `artifacts/${appId}/users/${userId}/canadian_finance_leads`;
                
                // Add the document to Firestore
                await addDoc(collection(db, collectionPath), newLead);

                // Success feedback
                statusMessageEl.className = 'mt-4 text-center font-medium text-secondary-green';
                statusMessageEl.textContent = 'Lead added successfully!';
                leadForm.reset(); // Clear the form
                
                // Hide message after a delay
                setTimeout(() => statusMessageEl.classList.add('hidden'), 3000);


            } catch (error) {
                console.error("Error adding document: ", error);
                statusMessageEl.className = 'mt-4 text-center font-medium text-red-600';
                statusMessageEl.textContent = `Error: ${error.message || 'Failed to add lead.'}`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Prospect Lead';
            }
        });

        /**
         * 3. Real-time Lead Listener and Renderer
         */
        function setupRealtimeLeads() {
            if (!userId) {
                console.error("Cannot set up leads listener: User ID is not defined.");
                return;
            }

            const collectionPath = `artifacts/${appId}/users/${userId}/canadian_finance_leads`;
            const leadsQuery = query(collection(db, collectionPath));
            
            // Start real-time listener
            onSnapshot(leadsQuery, (snapshot) => {
                const leads = [];
                snapshot.forEach(doc => {
                    // Add the document ID to the data object
                    leads.push({ id: doc.id, ...doc.data() });
                });

                renderLeads(leads);
            }, (error) => {
                console.error("Error listening to leads: ", error);
                loadingMsg.textContent = 'Error loading leads. See console.';
            });
        }

        function renderLeads(leads) {
            leadsTableBody.innerHTML = ''; // Clear existing rows
            loadingMsg.classList.add('hidden');

            if (leads.length === 0) {
                leadsTable.classList.add('hidden');
                loadingMsg.textContent = 'No leads captured yet.';
                loadingMsg.classList.remove('hidden');
                return;
            }

            leadsTable.classList.remove('hidden');

            // Sort by creation time (newest first, since Firestore can't guarantee order without an index)
            leads.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

            leads.forEach(lead => {
                const interestsText = lead.interests && lead.interests.length > 0
                    ? lead.interests.join(', ')
                    : 'None selected';
                
                // Use a green/red badge for status
                const statusClass = lead.isContacted ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const statusText = lead.isContacted ? 'Contacted' : 'New';
                
                // Create a single string for contact info for the tooltip
                const contactDetails = `Email: ${lead.email}\nPhone: ${lead.phone || 'N/A'}`;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150 group';
                row.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900" title="${contactDetails}">${lead.name}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${lead.province}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500 max-w-[150px] truncate" title="${interestsText}">${interestsText}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500 max-w-[120px] truncate" title="Source: ${lead.source}">${lead.source}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <span id="status-${lead.id}" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full cursor-pointer transition duration-150 ${statusClass}"
                              data-id="${lead.id}" data-status="${lead.isContacted}" onclick="toggleContactStatus('${lead.id}', ${lead.isContacted})">
                            ${statusText}
                        </span>
                    </td>
                `;
                leadsTableBody.appendChild(row);
            });
        }

        /**
         * 4. Toggle Contact Status
         */
        window.toggleContactStatus = async (leadId, currentStatus) => {
            if (!userId) {
                console.error("Authentication required to update status.");
                return;
            }

            const statusEl = document.getElementById(`status-${leadId}`);
            
            // Visual feedback for click
            statusEl.classList.add('opacity-50');

            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/canadian_finance_leads`;
                const leadDocRef = doc(db, collectionPath, leadId);
                
                // Toggle the status
                const newStatus = !currentStatus;

                await updateDoc(leadDocRef, {
                    isContacted: newStatus,
                    lastUpdated: serverTimestamp()
                });
                
                // UI update will be handled by the onSnapshot listener, but remove temporary visual cue
                statusEl.classList.remove('opacity-50');

            } catch (error) {
                console.error("Error updating document status: ", error);
                statusEl.classList.remove('opacity-50'); // Remove visual cue on failure
            }
        };


        // --- Content Generator Logic ---

        // Function to update the button text and state
        function updateContentButtonState() {
            const checkedInterests = document.querySelectorAll('input[name="interest"]:checked');
            generateContentBtn.disabled = checkedInterests.length === 0;
            if (checkedInterests.length === 0) {
                generateContentBtn.textContent = 'Select Product(s) Above to Activate';
            } else {
                generateContentBtn.textContent = `Generate Content for ${checkedInterests.length} Product(s)`;
            }
        }

        // Attach change listener to each checkbox for more reliable event detection.
        const interestCheckboxes = document.querySelectorAll('input[name="interest"]');
        interestCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateContentButtonState);
        });
        
        // Set initial button state when the script loads
        updateContentButtonState();

        generateContentBtn.addEventListener('click', generateMarketingContent);

        async function generateMarketingContent() {
            const checkedInterests = Array.from(document.querySelectorAll('input[name="interest"]:checked')).map(cb => cb.value);

            if (checkedInterests.length === 0) return;

            // UI feedback
            generateContentBtn.disabled = true;
            generateContentBtn.textContent = 'Generating Content... (Fetching Live Data)';
            generatedTextEl.innerHTML = '<div class="flex items-center justify-center space-x-2 text-primary-blue"><svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...</div>';
            contentSourcesEl.innerHTML = '';
            contentOutputContainer.classList.remove('hidden');

            const interestList = checkedInterests.join(', ');

            const systemPrompt = "You are a Canadian financial marketing expert. Your task is to generate one highly engaging, concise, and persuasive social media post (for platforms like LinkedIn or Twitter) targeting Canadian residents. The post must focus on the benefits of the requested financial products and include a clear, Canadian-specific call to action (like 'Contact us for a free plan'). The tone should be professional and motivating.";
            
            const userQuery = `Generate a social media post (less than 200 words) focusing on the benefits and urgency of planning for Canadian financial products: ${interestList}. Use current, up-to-date data and mention the Canadian government incentives where applicable.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await exponentialBackoffFetch(apiUrl, options);
                const result = await response.json();
                
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    
                    // 1. Extract and format generated text
                    generatedTextEl.textContent = text; 

                    // 2. Extract and display sources
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    
                    contentSourcesEl.innerHTML = '';
                    if (sources.length > 0) {
                        sources.forEach(source => {
                            const li = document.createElement('li');
                            li.innerHTML = `<a href="${source.uri}" target="_blank" class="text-primary-blue hover:underline">${source.title}</a>`;
                            contentSourcesEl.appendChild(li);
                        });
                    } else {
                         contentSourcesEl.innerHTML = '<li>No specific web sources cited for this content.</li>';
                    }

                } else {
                    generatedTextEl.textContent = 'Content generation failed. No text returned.';
                    contentSourcesEl.innerHTML = '';
                    console.error("API response was empty or malformed:", result);
                }

            } catch (error) {
                generatedTextEl.textContent = `A network or API error occurred: ${error.message}`;
                contentSourcesEl.innerHTML = '';
                console.error("Fetch Error:", error);
            } finally {
                generateContentBtn.disabled = false;
                generateContentBtn.textContent = `Generate Content for ${checkedInterests.length} Product(s)`;
            }
        }

        // Start the application lifecycle
        authenticateAndInitialize();

    </script>
</body>
</html>
